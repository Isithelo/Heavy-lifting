/*
                                                                                                    
                                                                                                    
                                                                                                    
                                                                                                    
                                             `,;+@@@';,                                             
                                        '@@@@@@@@@@@@@@@@@@@:                                       
                                    :@@@@@@@@@@@@@@@@@@@@@@@@@@@.                                   
                                 ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                 
                               +@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                              
                             #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                            
                           '@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`                          
                          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                         
                        #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                       
                       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                      
                     ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                     
                    +@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`                   
                   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                  
                  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:                 
                 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:                
                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.               
               +@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@               
              ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@              
              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             
             @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#            
            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            
            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           
           @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#          
          '@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@          
          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         
         #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         
         @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
        +@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
        @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       
       .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       
       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:      
       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@   @@@@@####@   .     '@@@@@@@@@@@@@@@@@@@@@@@@      
      :@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@'   @@@;                 @@@@@@@@@@@@@@@@@@@@@@@      
      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`   @@                    @@@@@@@@@@@@@@@@@@@@@@:     
      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    @                      .              ;@@@@@@     
      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`  @@@@@@:   @.                      : :++++++++'       @@@     
     '@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@   .@@@@@ ;`                  @+      @@@@@@@@@@@@@@';          
     @@@@@@@@@@@@@@@@@@@@#@@@@@@@@@; `  @@@@@:                     @      `;@@@@@@@@@@@@@@@@:  :    
     @@@@@@@@@@@@@@@@@@     ,@@@@@@  @   @@@#                ++            ` ,@@@@@@@@@@@@@@@@@#    
     @@@@@@@@@@@@@@@@@        `@;        ;@@,                @@            @`  @@@@@@@@@@@@@@@@@    
     @@@@@@@@@@@@@@@@   @,    `           @@                +@@@          `  '  +@@@@@@@@@@@@@@@    
    `@@@@@@@@@@@@@@@;  @@@@@ ;            ;#                 @@@@.           @@  .@@@@@@@@@@@@@@    
    ,@@@@@@@@@@@@@@@  @@@@@@                              @  ,@@@@@       .  @@@   @@@@@@@@@@@@@    
    ;@@@@@@@@@@@@@@  @@@@@@                         .    @@   @@@@@@@@#'     @@@@:  @@@@@@@@@@@@    
    '@@@@@@@@@@@@@  ,@@@@@'                        @.   @@@@  .@@@@@@@@@'   @@@@@@@  @@@@@@@@@@@    
    @@@@@@@@@@@@@#  @@@@@@                      `  @@@#@@@@@'  @@@@@@@@@@@  :@@@@@@@  @@@@@@@@@@    
    @@@@@@@@@@@@@  #@@@@@:                     ;   @@@@@@@@@@  +@@@@@@@@@@@,:@@@@@@@@  @@@@@@@@@    
    @@@@@@@@@@@@   @@@@@@                     ;@   @@@@@@@@@@  +@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@@    
    '@@@@@@@@@@.  @@@@@@#                `@::@@@  .@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@    
    ;@@@@@@@@@@   @@@@@@;                @@@@@@@  @@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@  @@@@@@    
    ,@@@@@@@@@   @@@@@@@;               `@@@@@@@  @@@@@@@@@@@@+   :;@@@@@@@@@@@@@@@@@@@@@  @@@@@    
     @@@@@@@@.   @@@@@@@:               @@@@@@@@  @@@@@@@@@@@@@@`   `@@@@@@@@@@@@@@@@@@@@. ;@@@@    
     @@@@@@@@   @@@@@@@@:              @@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  @@@@    
     @@@@@@@#  @@@@@@@@@;             @@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@    
     @@@@@@@  @@@@@@@@@@;            @@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@'    
     @@@@@@  @@@@@@@@@@@@           @@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`    
     :@@@@  #@@@@@@@@@@@@          @@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     
      @@@: :@@@@@@@@@@@@@@       +@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     
      @@@  @@@@@@@@@@@@@@@@:`:` +@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     
      @@  @@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`     
      .  @@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      
        ;@@@@@@@@@@@@@@@@@@@@@ ,@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@      
       ;@@@@@@@@@@@@@@@@@@@@@  +@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`      
        @@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@: ;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       
        @@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+       
        ,@@@@@@@@@@@@@@@@@@  .@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
         @@@@@@@@@@@@@@@@   ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
         ,@@@@@@@@@@@@,    #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         
          @@@@@@@@@@@@,  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#         
          `@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@          
           @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,          
            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           
            ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            
             @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.            
              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             
               @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@              
               `@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@               
                ,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                
                 :@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 
                  :@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                  
                   .@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                   
                     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                    
                      @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#                     
                       #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.                      
                        `@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                        
                          #@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,                         
                            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+                           
                              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#                             
                                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@'                               
                                  :@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`                                 
                                     :@@@@@@@@@@@@@@@@@@@@@@@@@`                                    
                                         ,#@@@@@@@@@@@@@@@'`                                                                                                        
                                         */
                                         var express = require('express');
                                         var path = require('path');
                                         var logger = require('morgan');
                                         var compression = require('compression');
                                         var methodOverride = require('method-override');
                                         var session = require('express-session');
                                         var flash = require('express-flash');
                                         var bodyParser = require('body-parser');
                                         var expressValidator = require('express-validator');
                                         var dotenv = require('dotenv');
                                         var exphbs = require('express-handlebars');
                                         var mongoose = require('mongoose') 
                                         var passport = require('passport');
                                         var recaptcha = require('express-recaptcha');
                                         var braintree = require("braintree");
                                         var nodemailer = require('nodemailer');
//set the plugin controller directory
var directory =  __dirname +'/'
var app = express();

///////////////////////////////////////////////
////     SET YOUR APP.JSON DETAILS        //// 
/////////////////////////////////////////////
//Not working ? try double dots on the json url..
var myModule = require('../../app.json');
var sitename = myModule.sitename
var website = myModule.website
var repo = myModule.repo

///////////////////////////////////////
////       VIEWS DIRECTORY        //// 
/////////////////////////////////////
//Set Handlebars view directory for plugins
app.set('views', path.join(__dirname, 'views/'));

///////////////////////////////////
////       CONTROLLERS        //// 
///////////////////////////////// 
// Controllers - Common
var HomeController = require('../../controllers/home');

//Heavy-lifting Controllers
var initController = require(directory+'controllers/initialize');
var adminController = require(directory+'controllers/admin');
var createController = require(directory+'controllers/create');
var readController = require(directory+'controllers/read');
var readAssembliesController = require(directory+'controllers/readassemblies');
var createAssembliesController = require(directory+'controllers/createassemblies');
var deleteController = require(directory+'controllers/delete');
var pagesController = require(directory+'controllers/pages');
var productController = require(directory+'controllers/product');
var assemblyController = require(directory+'controllers/assembly');
var componentController = require(directory+'controllers/component');
var componentController = require(directory+'controllers/component');
var organizationController = require(directory+'controllers/organization');

///////////////////////////   THESE ROUTES CAN BE REMOVED FOR CUSTOM SITES   ///////////////////////////
var heavyliftingController = require(directory+'controllers/heavylifting');


//////////////////////////////////////////////////////////////////////////

/////////////////////////////
////       PAGES        //// 
///////////////////////////
//The pages JSON will be linked to the ROBOT.txt which will effectivly create the pages for the site.
var pageGet = [{ 
  url : '/getCollectionData',
  route :  readController.getCollectionData 
  },//admin page table view.
  { 
    url : '/getdata',
    route :  readController.getdata 
  },//get data by array of ids.
  { 
    url : '/getdatacomp',
    route :  readController.getdatacomp 
  },//get data by array of ids.
  { 
    url : '/parentid',
    route :  readController.parentid 
  },//get data by parentid
  { 
    url : '/getshortdata',
    route :  readController.getshortdata 
  },//get data 
  { 
    url : '/jstree',
    route :  readController.jstree 
  },//get jstree 
  { 
    url : '/getformfield',
    route :  readController.getformfield 
  },//get the select ddrop down items
  { 
    url : '/templatename',
    route :  readController.templatename 
  },//get the select templatename
  { 
    url : '/groups',
    route :  readController.groups 
  },//get the select groups
  { 
    url : '/navmenuload',
    route :  readController.navmenuload 
  },//get the navmenu
  { 
    url : '/loadusermenu',
    route :  readController.loadusermenu 
  },//get the usermenu
  { 
    url : '/loadcompmenu',
    route :  readController.loadcompmenu 
  },//get the loadcompmenu
  { 
    url : '/singleidcall',
    route :  readController.singleidcall 
  },//get the single element by id
  { 
    url : '/findme',
    route :  readController.findme 
  },//get the single element by id
  { 
    url : '/getassemblyall',
    route :  readController.getassemblyall 
  },//get the get assembly all element id
  { 
    url : '/defaultassy',
    route :  readController.defaultassy 
  },//get the get assembly all element id
  { 
    url : '/getcompform',
    route :  readController.getcompform 
  },// getformraw
  { 
    url : '/productload',
    route :  productController.productload 
  },// shop product loader
  { 
    url : '/getform',
    route :  [componentController.additionaldetails , readController.getform]
  },// shop product loader
  { 
    url : '/templateload',
    route :  readController.templateload 
  },//Load Template
  { 
    url : '/deleteentryperm',
    route :  deleteController.deleteentryperm 
  },//get data by array of ids.
  { 
    url : '/deleteentry',
    route :  deleteController.deleteentry 
  },//get data by array of ids permanently.
  { 
    url : '/getscada',
    route :  readController.getscada 
  },{ 
    url : '/gethistory',
    route :  readController.gethistory 
  },{ 
    url : '/querythis',
    route :  readController.querythis 
  },
  { 
    url : '/getuserdetails/:userid',
    route : [  heavyliftingController.heavyliftingalluser,  heavyliftingController.getuserdetails ] ,
  },
  { 
    url : '/:template/:compgroupid',
    route : [readController.query,readController.query1,readController.query2,readController.query3,readController.query4 , componentController.compmore]
  },
  { 
    url : '/view',
    route :  pagesController.page ,
    templatename : directory+'/views/page',
  }
  ]




  var pagePost =  [
  { 
    url : '/create',
    route :  createController.create 
  },//Create Single Entry
   { 
    url : '/bulkedit',
    route :  createController.bulkedit 
  },//Create a set of entries
  ] 

////////////////////////////////////
////       INSTRUCTIONS        //// 
//////////////////////////////////
/*

To start a new collection. 
1. Add a new element to the collections JSON object below. This should be a unique key , with details on the items determining the method of reading the data structure.


*/

///////////////////////////////////
////       COLLECTIONS        //// 
/////////////////////////////////
//Define you collection names. These then set the routing paths to follow for the heavy-lifting engine.
var collections = {
  'database' : {
    'collectionName' : "heavylifting",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",//Where is the form set defining the site.
    'datacollectionname' : "heavylifting",
    'additionaldetailcollection' : "heavylifting", //WHere is the additional form data stored.
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.
    'parentids' : '58d2010b118e812d18654119',//which form was the parent.
    'navigationform' : '58aa74150b9d3241280ecf18',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f4ad70b06ad944ac043794',//The location to file issues with this item.
    'pagetitle' : 'Database',
    'description' : 'The database contains every discrete element of a conveyor system that can be stored on the site. These elements are used throughout the site as list entries form groups, sets of components and data entries.'
  },
  'projects' : {
    'collectionName' : "projects",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",//Where is the form set defining the site.
    'datacollectionname' : "projects",
    'additionaldetailcollection' : "heavylifting", //WHere is the additional form data stored.
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.
    'parentids' : '5abf31b1b6aede19c4774e3e',//which form was the parent.
    'navigationform' : '58aa74150b9d3241280ecf18',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f4ad70b06ad944ac043794',//The location to file issues with this item.
    'pagetitle' : 'Projects',
    'description' : 'Create, read, update and delete your projects.'
  },
  'shop' : {
    'collectionName' : "heavylifting",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",
    'datacollectionname' : "heavylifting",
    'additionaldetailcollection' : "heavylifting",
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.
    'parentids' : '58d222d18d9bfd28846eb792',//which form was the parent.
    'navigationform' : '58aa74150b9d3241280ecf18',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f5527af68865104063bd21',//The location to file issues with this item.
    'pagetitle' : 'Shop',
    'description' : 'The shop contains all of the equipment to be used in purchasing schedules on this site. Please contact us via email if you would like to incorporate your product into this list.'
  },
  'forms' : {
    'collectionName' : "heavylifting",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",//(heavylifting,forms)
    'datacollectionname' : "heavylifting", //(heavylifting,forms)
    'additionaldetailcollection' : "heavylifting",
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.  (58aa74130b9d3241280ecf16 ,59e82a7be0f9501550e9cf57)
    'parentids' : '58df3fdc48e76c2c1894d704',//which form was the parent.   (58df3fdc48e76c2c1894d704 , 59e837b69399ad427c493d4e)
    'navigationform' : '59e83518e0f9501550e9cf81',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f4ad70b06ad944ac043794',//The location to file issues with this item.
    'pagetitle' : 'Forms',
    'description' : 'Combinator for database items and entries into forms.'
  },
  'configuration' : {
    'collectionName' : "heavylifting",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",//(heavylifting,forms)
    'datacollectionname' : "heavylifting", //(heavylifting,forms)
    'additionaldetailcollection' : "heavylifting",
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.  (58aa74130b9d3241280ecf16 ,59e82a7be0f9501550e9cf57)
    'parentids' : '5a5054af39da3236d859ce8a',//which form was the parent.   (58df3fdc48e76c2c1894d704 , 59e837b69399ad427c493d4e)
    'navigationform' : '59e83518e0f9501550e9cf81',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f4ad70b06ad944ac043794',//The location to file issues with this item.
    'pagetitle' : 'Configuration',
    'description' : 'Form and site configuration forms.'
  },
  'assemblies' : {
    'collectionName' : "assemblies",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "forms",
    'datacollectionname' : "assemblies",
    'additionaldetailcollection' : "heavylifting",
     'rawform' : '59e82a7be0f9501550e9cf57',//which form was the raw.
    'parentids' : '59e83513e0f9501550e9cf80',//which form was the parent.
    'navigationform' : '59e83518e0f9501550e9cf81',  //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f55271f68865104063bd20',//The location to file issues with this item.
    'pagetitle' : 'Assemblies',
    'description' : 'The assembly page allows for the combination of all site entries in complex reporting structures. Build contracts, create purchasing instructions and build equipment.'
  },  
  'components' : {
    'collectionName' : "heavylifting",//This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "heavylifting",
    'datacollectionname' : "heavylifting",
    'additionaldetailcollection' : "heavylifting",
    'rawform' : '58aa74130b9d3241280ecf16',//which form was the raw.
    'parentids' : '58d371b01373c63dccdee169',//which form was the parent.
    'navigationform' : '58aa74150b9d3241280ecf18', //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f55283f68865104063bd22',//The location to file issues with this item.
    'pagetitle' : 'Components',
    'description' : 'The components page allows for the creation, viewing, updating and deleting of items on this site. Use the components to create new assembly structures for later use in reporting.'
  },  
  'issues' : {
    'collectionName' : "forms", //This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "forms", //Where is the form data stored.
    'datacollectionname' : "wrasse", // Where is the template data stored.
    'additionaldetailcollection' : "heavylifting",
    'rawform' : '59e82a7be0f9501550e9cf57',//which form was the raw.
    'parentids' : '59ea2866f388250158100b5c',//which form was the parent.
    'navigationform' : '59e83518e0f9501550e9cf81', //Which form is the nav menu ??? Legacy ???
    'issueparent':'59f4ad70b06ad944ac043794',//The location to file issues with this item.
    'pagetitle' : 'Issues',
    'description' : 'Issue tracking for this site.'
  },  
  'scada' : {
    'collectionName' : "forms", //This is the collecion name to be used on the Mongoddb database.
    'formcollectionname' : "forms", //Where is the form data stored.
    'datacollectionname' : "entanglement", // Where is the template data stored.
    'additionaldetailcollection' : "scada",
    'rawform' : '59e82a7be0f9501550e9cf57',//which form was the raw.
    'parentids' : '59fd5eca077e477b30dd0967',//which form was the parent.
    'navigationform' : '59e83518e0f9501550e9cf81', //Which form is the nav menu ??? Legacy ???
    'issueparent':'5a3dd58b29f4672314975414',//The location to file issues with this item.
    'pagetitle' : 'Data Analysis',
    'description' : 'This page is a proof of concept for using the heavylifting framework as a SCADA lite and data analysis enabler.'
  }
}

var models = {}

function buildModel(route){
  var mongoose = require('mongoose')
  , Schema = mongoose.Schema
  , ObjectId = Schema.ObjectId;
  var modelBuilder;
  var modelBuilder = mongoose.Schema({
    'name' :{ type: String, default: 'Inital Form' },
    'detail' :String,
'objectType' :String,       //child type will be a form id , used for determining what component is created by the form.
'childType' :String,        //Used for the routing of new posts
'route' :String,
'entry' :Schema.Types.Mixed,
'parentid' :String,
'name' :String,
'visibility' : String,        //Defines if this is publicly visibile
'userowner':String,         //The username the owner.
'organizationowner':String,     //The organization name of the owner.
'organizations' :String,      //permissions for edit / read access
'users' :String,          //permissions for edit / read access
'elementID' :{ type: String, default: '' },
'userID' :String,         //Oringial creator by user ID , will be good for tracing and error fallback
'revision' :{ type: String, default: 'created' },
'created' : { type: Date, default: Date.now },
'active' : { type: String, default: "true" },
}, { collection: route });



  return modelBuilder = mongoose.model(route, modelBuilder,route);
}

var routeSet = {}

//////////////////////////////////////
////       DEFINE ROUTING        //// 
////////////////////////////////////
//Set up the routing for the collections , gets and posts.

//Ensure all of the models are built for the page... Dont want to miss any !
for (key in collections) {
  if (!models[collections[key]['collectionName']] ){
    models[collections[key]['collectionName']] = buildModel(collections[key]['collectionName'])
    console.log('\x1b[36m%s\x1b[0m',collections[key]['collectionName'] + ' : Model Compliled')
  }   
  if (!models[collections[key]['formcollectionname']] ){
    models[collections[key]['formcollectionname']] = buildModel(collections[key]['formcollectionname'])
    console.log('\x1b[36m%s\x1b[0m',collections[key]['formcollectionname'] + ' : Model Compliled')
  }   
  if (!models[collections[key]['datacollectionname']] ){
    models[collections[key]['datacollectionname']] = buildModel(collections[key]['datacollectionname'])
    console.log('\x1b[36m%s\x1b[0m',collections[key]['datacollectionname'] + ' : Model Compliled')
  }   
  if (!models[collections[key]['additionaldetailcollection']] ){
    models[collections[key]['additionaldetailcollection']] = buildModel(collections[key]['additionaldetailcollection'])
    console.log('\x1b[36m%s\x1b[0m',collections[key]['additionaldetailcollection'] + ' : Model Compliled')
  }  
}


for (key in collections) {
//Compile the collection models.
for (var i = 0; i < pagePost.length; i++) {
  routeSet['/' + key + pagePost[i]['url']] = key
        //Define the Routing
        var temp = JSON.parse(JSON.stringify(pagePost[i]))
        app.post(
          '/' + key + pagePost[i]['url'],
          function(req, res,next){
            //INJECT DATA INTO THE RES QUERY.
            res.locals.routeSet = routeSet[req.route.path] 
            res.locals.pagedetail = temp
            res.locals.collections = collections
            res.locals.models = models
/*
            console.log('----------  DEBUGGING  ----------')
            console.log('Directory Name : '+__dirname)
            console.log('Original req URL : '+req.originalUrl  )
            console.log('Query :')
            for (key in req.query) {
              console.log('     ' + key + ' : ' + req.query[key])
            }
            //console.log('Passing Parameters :')
            //console.log(res.locals)
            console.log('----------  DEBUGGING  ----------')
            console.log()
            */
            //View compiled models.
            for (key in mongoose.connection.models) {
                 // console.log('Current compiled models : '+ key)
               }
               next();
             },
             pagePost[i]['route']
             )
      }
      for (var i = 0; i < pageGet.length; i++) {
        routeSet['/' + key + pageGet[i]['url']] = key
        //Define the Routing
        var temp = JSON.parse(JSON.stringify(pageGet[i]))
        app.get(
          '/' + key + pageGet[i]['url'],
          function(req, res,next){
            //INJECT DATA INTO THE RES QUERY.
            res.locals.routeSet = routeSet[req.route.path] 
            res.locals.pagedetail = temp
            res.locals.collections = collections
            res.locals.models = models

/*
            console.log('----------  DEBUGGING  ----------')
            console.log('Directory Name : '+__dirname)
            console.log('Original req URL : '+req.originalUrl  )
            console.log('Query :')
            for (key in req.query) {
              console.log('     ' + key + ' : ' + req.query[key])
            }
            //console.log('Passing Parameters :')
            //console.log(res.locals)
            console.log('----------  DEBUGGING  ----------')
            console.log()
            */

            //View compiled models.
            for (key in mongoose.connection.models) {
                 // console.log('Current compiled models : '+ key)
               }
               next();
             },
             pageGet[i]['route']
             )
      }
    }


/////////////////////////////////
////       HOME             //// 
///////////////////////////////
app.get('/',
  componentController.componentforms, 
  componentController.usercomponents,
  organizationController.userorganizations,
  componentController.organizationcomponents,
  heavyliftingController.heavyliftingalluser, 
  HomeController.index
  );





//////////////////////////////////////////////////////////////////////////

/////////////////////////////
////       PAGES        //// 
///////////////////////////
//app.get('/database', pagesController.database);
//app.get('/shop', pagesController.shop);
//app.get('/documentation', pagesController.documentation);
//app.get('/heavylifting/forms', pagesController.forms);
//app.get('/configuration', pagesController.configuration);
//app.get('/reports', pagesController.reports); 

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////
////       INITIALIZE DATABASE         //// 
//////////////////////////////////////////
app.get('/init', initController.deletedb);
app.get('/deletedb', initController.deletedb);
app.get('/getdb', initController.getdb);

//////////////////////////////////////////////////////////////////////
////        PRIMARY ADMINISTRATIVE DATABASE MODIFICATION         //// 
////////////////////////////////////////////////////////////////////
app.get('/hl-admin', adminController.hadmin);
app.get('/read',  adminController.read);
app.get('/update',  adminController.update);
app.get('/delete',  adminController.delete);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*
/////////////////////////////////
////        DATABASE        //// 
///////////////////////////////
app.get('/heavylifting/templateload', readController.templateload);//Load Template

/////////////////////////////////////////
////       CREATE CONTROLLERS       //// 
///////////////////////////////////////
app.post('/heavylifting/create',  createController.create);

///////////////////////////////////////////
////       DELETE CONTROLLERS         //// 
/////////////////////////////////////////
app.get('/heavylifting/deleteentryperm', deleteController.deleteentryperm);//get data by array of ids.
app.get('/heavylifting/deleteentry', deleteController.deleteentry);//get data by array of ids permanently.

///////////////////////////////////////////////////////
////       READ CONTROLLERS - HEAVYLIFTING        //// 
/////////////////////////////////////////////////////
app.get('/getCollectionData', readController.getCollectionData);//admin page table view.
app.get('/heavylifting/getdata', readController.getdata);//get data by array of ids.
app.get('/heavylifting/getdatacomp', readController.getdatacomp);//get data by array of ids.
app.get('/parentid', readController.parentid);//get data by parentid
app.get('/getshortdata', readController.getshortdata);//get data 
app.get('/heavylifting/jstree', readController.jstree);//get jstree 
app.get('/heavylifting/getformfield', readController.getformfield);//get the select ddrop down items
app.get('/heavylifting/templatename', readController.templatename);//get the select templatename
app.get('/heavylifting/groups', readController.groups);//get the select groups
app.get('/navmenuload', readController.navmenuload);//get the navmenu
app.get('/loadusermenu', readController.loadusermenu);//get the usermenu
app.get('/loadcompmenu', readController.loadcompmenu);//get the loadcompmenu
app.get('/singleidcall', readController.singleidcall);//get the single element id
app.get('/heavylifting/findme', readController.findme);//get the single element id
app.get('/getassemblyall', readController.getassemblyall);//get the get assembly all element id
app.get('/defaultassy', readController.defaultassy);//get the get assembly all element id
app.get('/getformraw', readController.getformraw);// getformraw
app.get('/getcompform', readController.getcompform);// getformraw

/////////////////////////////////////////////////////
////       READ CONTROLLERS - ASSEMBLIES        //// 
///////////////////////////////////////////////////
app.get('/assemblies/jstree', readAssembliesController.jstree);//get jstree 
app.get('/assemblies/getform',  componentController.additionaldetails , readAssembliesController.getform);//search for the form to load.
app.get('/assemblies/getraw',  readAssembliesController.getraw);//search for the form to load.
app.get('/assemblies/getdata', readAssembliesController.getdata);//get data by array of ids.
app.post('/assemblies/create',  createAssembliesController.create);
app.get('/assemblies/assemblyload', readAssembliesController.assemblyload);// getformraw

/////////////////////////////////////
////       PRODUCTS             //// 
///////////////////////////////////
app.get('/heavylifting/productload', productController.productload);// getformraw
app.get('/heavylifting/getform',  componentController.additionaldetails , readController.getform);//search for the form to load.
*/

/////////////////////////////////////
////       ASSEMBLY             //// 
///////////////////////////////////
app.get('/assembly/new',  assemblyController.newassy);
//Messing here.


//////////////////////////////////////
////       REDUNDANT             //// 
////////////////////////////////////
app.get('/cvpageload', readController.cvpageload);




//Viewer and calculator (Group) - Stage 2
//app.get('/components/:template/:compgroupid',readController.query,readController.query1,readController.query2,readController.query3,readController.query4 , componentController.compmore);


///////////////////////////////////
////       COMPONENTS         //// 
/////////////////////////////////
//app.get('/components/', componentController.components);


//Rebuild routing
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
 

///////////////////////////////////////////////////
////        USER INTERFACE CONTROLLER         //// 
/////////////////////////////////////////////////
app.get('/users/', heavyliftingController.users);
app.get('/users/:username/',componentController.componentforms, componentController.usercomponents,organizationController.userorganizations,componentController.organizationcomponents,heavyliftingController.heavyliftingalluser ,heavyliftingController.profile);
app.get('/users/:username/settings/',heavyliftingController.settings);
app.get('/users/:username/settings/:page', componentController.componentforms,componentController.usercomponents,organizationController.userorganizations,componentController.organizationcomponents , heavyliftingController.page);
app.get('/usersearch', heavyliftingController.usersearch);

app.get('/componentssuperadmin/', componentController.componentssuperadmin);
app.get('/component/new', organizationController.ajaxorguserread , componentController.componentforms, componentController.newcomp);

//User Components
app.get('/components/users/', componentController.usersview);
app.get('/components/users/:username/', componentController.users);
app.get('/components/users/:username/:compid', componentController.compiduser);
//Organization Components
app.get('/components/organizations/', componentController.organizationsview);
app.get('/components/organizations/:orgname', componentController.organizations);
app.get('/components/organizations/:orgname/:compid', componentController.compidorg);


*/



//last line
module.exports = app;